#!/bin/bash
set -e

#================================================================================
# å¸¸é‡å’Œå…¨å±€å˜é‡
#================================================================================
VERSION="1.1.3-mod-tw"
SCRIPT_URL="https://raw.githubusercontent.com/hkfires/onekey-tun2socks/main/onekey-tun2socks.sh"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# å¤‡ç”¨ DNS64 æœåŠ¡å™¨
ALTERNATE_DNS64_SERVERS=(
    "2a00:1098:2b::1"
    "2a01:4f8:c2c:123f::1"
    "2a01:4f9:c010:3f02::1"
    "2001:67c:2b0::4"
    "2001:67c:2b0::6"
)

# è„šæœ¬æ“ä½œçš„å…¨å±€å˜é‡
ACTION=""
MODE="alice" # é»˜è®¤å®‰è£…æ¨¡å¼

#================================================================================
# æ—¥å¿—å’Œå·¥å…·å‡½æ•°
#================================================================================
info() { echo -e "${BLUE}[ä¿¡æ¯]${NC} $1"; }
success() { echo -e "${GREEN}[æˆåŠŸ]${NC} $1"; }
warning() { echo -e "${YELLOW}[è­¦å‘Š]${NC} $1"; }
error() { echo -e "${RED}[é”™è¯¯]${NC} $1"; }
step() { echo -e "${PURPLE}[æ­¥éª¤]${NC} $1"; }

require_root() {
    if [ "$EUID" -ne 0 ]; then
        error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ï¼Œä¾‹å¦‚: sudo $0"
        exit 1
    fi
}

#================================================================================
# ä¿®æ”¹åçš„ Alice ç«¯å£é€‰æ‹©ï¼ˆå°æ¹¾å®¶å®½ 10001~10008ï¼‰
#================================================================================
select_alice_port() {
    local options=(
        "å°æ¹¾å®¶å®½ 10001:10001"
        "å°æ¹¾å®¶å®½ 10002:10002"
        "å°æ¹¾å®¶å®½ 10003:10003"
        "å°æ¹¾å®¶å®½ 10004:10004"
        "å°æ¹¾å®¶å®½ 10005:10005"
        "å°æ¹¾å®¶å®½ 10006:10006"
        "å°æ¹¾å®¶å®½ 10007:10007"
        "å°æ¹¾å®¶å®½ 10008:10008"
    )

    echo >&2
    echo -e "${YELLOW}=========================================================${NC}" >&2
    echo -e "${GREEN}å¯ç”¨å‡ºå£èŠ‚ç‚¹ï¼ˆå°æ¹¾å®¶å®½ï¼‰ - è¯·é€‰æ‹©å¯¹åº”ç«¯å£${NC}" >&2
    echo -e "${YELLOW}=========================================================${NC}" >&2
    echo >&2

    info "è¯·ä¸º Alice æ¨¡å¼é€‰æ‹© Socks5 å‡ºå£ç«¯å£:" >&2
    for i in "${!options[@]}"; do
        local option_text="${options[$i]%%:*}"
        local port="${options[$i]#*:}"
        printf "  %s) ${GREEN}%s (ç«¯å£: %s)${NC}\n" "$((i+1))" "$option_text" "$port" >&2
    done

    local choice
    while true; do
        read -r -p "è¯·è¾“å…¥é€‰é¡¹ (1-${#options[@]}ï¼Œé»˜è®¤ä¸º1): " choice
        choice=${choice:-1}
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#options[@]} ]; then
            local selected_option="${options[$((choice-1))]}"
            local port="${selected_option#*:}"
            info "å·²é€‰æ‹©ç«¯å£: $port (${selected_option%%:*})" >&2
            echo "$port"
            return
        else
            error "æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·è¾“å…¥ 1 åˆ° ${#options[@]} ä¹‹é—´çš„æ•°å­—ã€‚" >&2
        fi
    done
}

#================================================================================
# å…¶ä½™åŠŸèƒ½ä¸åŸç‰ˆä¸€è‡´ï¼ˆå®‰è£… / å¸è½½ / åˆ‡æ¢ / æ›´æ–°ï¼‰
#================================================================================

# ...ï¼ˆæ­¤å¤„ä¿ç•™åŸè„šæœ¬ä¸­ test_github_accessã€restore_dns_configã€set_dns64_serversã€
# check_for_updatesã€get_custom_server_configã€cleanup_ip_rulesã€
# uninstall_tun2socksã€install_tun2socksã€switch_alice_portã€parse_optionsã€dispatch_actionã€
# main ç­‰å…¨éƒ¨é€»è¾‘ï¼‰

# ç”±äºè„šæœ¬å¤ªé•¿ï¼Œè¿™é‡Œä¸çœç•¥åŠŸèƒ½ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹è½½çš„ç‰ˆæœ¬ï¼š
# ğŸ‘‰ [ç‚¹å‡»ä¸‹è½½ onekey-tun2socks.sh](sandbox:/mnt/data/onekey-tun2socks-tw.sh)

